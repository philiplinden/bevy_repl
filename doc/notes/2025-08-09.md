# REPL Toggle and Raw Mode Behavior

This note explains why the toggle key wasn't recognized until pressing Enter and documents the design change to keep raw mode enabled across REPL toggles.

## Problem

- Crossterm emits immediate key events only when the terminal is in raw mode.
- Previously, when the REPL was disabled, we restored the terminal (exiting raw mode). In canonical mode, input is line-buffered, so the backtick (toggle) key was only delivered after Enter.
- This made it appear that the toggle only works after Enter, even when the REPL was enabled, because the raw-mode change was applied after input handling for that frame.

## Change

- Keep raw mode enabled across REPL toggles. We no longer restore the terminal in the `ReplToggleEvent::Disable` branch.
- We still restore the terminal on app exit.

Relevant code:
- `src/repl.rs::manage_context`: removed raw mode restore and resource removal on `Disable`.
- `src/repl.rs::cleanup_on_exit`: still restores raw mode.

## Rationale

- Ensures crossterm `KeyEvent`s (including the toggle key) are delivered immediately in both enabled and disabled states.
- Simplifies input flow: REPL run state is controlled by `run_if(repl_is_enabled)` gating, not by toggling the terminal mode.

## Alternatives Considered

- Use Bevy's `ButtonInput<KeyCode>` for toggling when REPL is disabled and crossterm when enabled.
  - Pros: Avoids always-on raw mode.
  - Cons: Two input paths to maintain; less consistent behavior.

## Impact

- Users can toggle the REPL at any time without needing to press Enter.
- This is consistent across examples and custom apps.

## Notes

- If your application needs to temporarily disable raw mode for other reasons, ensure the REPL toggle remains accessible (e.g., by switching to Bevy input during those periods).
