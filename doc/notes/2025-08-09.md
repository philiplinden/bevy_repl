# REPL Toggle and Raw Mode Behavior

This note explains why the toggle key wasn't recognized until pressing Enter and documents the design change to keep raw mode enabled across REPL toggles.

## Problem

- Crossterm emits immediate key events only when the terminal is in raw mode.
- Previously, when the REPL was disabled, we restored the terminal (exiting raw mode). In canonical mode, input is line-buffered, so the backtick (toggle) key was only delivered after Enter.
- This made it appear that the toggle only works after Enter, even when the REPL was enabled, because the raw-mode change was applied after input handling for that frame.

## Change

- Keep raw mode enabled across REPL toggles. We no longer restore the terminal in the `ReplToggleEvent::Disable` branch.
- We still restore the terminal on app exit.

Relevant code:
- `src/repl.rs::manage_context`: removed raw mode restore and resource removal on `Disable`.
- `src/repl.rs::cleanup_on_exit`: still restores raw mode.

## Rationale

- Ensures crossterm `KeyEvent`s (including the toggle key) are delivered immediately in both enabled and disabled states.
- Simplifies input flow: REPL run state is controlled by `run_if(repl_is_enabled)` gating, not by toggling the terminal mode.

## Alternatives Considered

- Use Bevy's `ButtonInput<KeyCode>` for toggling when REPL is disabled and crossterm when enabled.
  - Pros: Avoids always-on raw mode.
  - Cons: Two input paths to maintain; less consistent behavior.

## Impact

- Users can toggle the REPL at any time without needing to press Enter.
- This is consistent across examples and custom apps.

## Notes

- If your application needs to temporarily disable raw mode for other reasons, ensure the REPL toggle remains accessible (e.g., by switching to Bevy input during those periods).
 
---

# Design Decision: Prompt visual modes (minimal vs pretty)

Date: 2025-08-09

## Summary

- Provide two visual modes for the REPL prompt bar:
  - Minimal: 1-line bar, no border/colors/hints.
  - Pretty: 1-line bar with border, title, colorful styles, and right-aligned hint.
- “Pretty” is gated behind a Cargo feature `prompt-pretty`.

## Implementation

- Added single configuration resource `ReplPromptConfig` in `src/prompt/mod.rs` with fields:
  - `border: bool` (default true)
  - `color: bool` (default false)
  - `hint: bool` (default true)
- Implemented renderer in `src/prompt/render.rs::display_prompt()` using ratatui via `ReplContext`:
  - Fixed bottom bar (1 row content) with horizontal scrolling to keep cursor visible.
  - Optional border/title, styled prompt symbol, and right-aligned hint.
- New submodule `src/prompt/visual/`:
  - `PromptMinimalPlugin` (no feature): sets `border=false, color=false, hint=false`.
  - `PromptPrettyPlugin` (feature-gated): sets `border=true, color=true, hint=true`.
- Cargo feature: `prompt-pretty` in `Cargo.toml`.
- `src/plugin.rs::ReplPlugins` conditionally adds `PromptPrettyPlugin` when the feature is enabled.

## Rationale

- Keeps runtime configuration simple and overridable via one resource.
- Feature-gating the pretty mode avoids pulling in optional styling paths for minimal users.
- Renderer constrained to 1-line output to avoid covering normal stdout and to keep the prompt fixed at the bottom.

## Future Work

- Optional multi-line wrapping mode behind a separate knob.
- Theming (color choices), and togglable cursor style via crossterm if desired.

# 2025-08-09 Review

## README Design Assessment (`README.md`)

- __Scope__: Terminal REPL for headless Bevy using `clap` parsing and `bevy_ratatui` I/O. Provides toggleable input area and observer-based command execution. Public API exposed via `bevy_repl::prelude::*`.
- __Strengths__:
  - Clear positioning as alternative to `bevy-console` for terminal-first apps.
  - Two authoring styles for commands: builder and optional derive.
  - Schedules and integration with `bevy_ratatui::event::InputSet` documented.
- **Gaps / Inconsistencies**:
  - Feature flag naming mismatch: table shows `default_commands`, usage shows `features = ["default-commands"]`. Pick one and standardize (prefer underscore in Cargo feature names or align with existing in `Cargo.toml`).
  - Method name inconsistency in examples: trait uses `fn clap_command()` but later example uses `fn command()`; should be `clap_command()` everywhere.
  - Known issues list includes non-functional `help`/`clear`; either disable by default or fix soon.
  - Raw mode/toggle narrative conflicts with current code (see below).

## Example Ergonomics (`examples/`)

Files present: `minimal.rs`, `toggle.rs`, `builder.rs`, `derive.rs`, `builtins.rs`, `key_events.rs`, `update_resource.rs`, `aliases.rs`, `window.rs`.

- __API Surface__: Via `prelude` in `src/lib.rs`, users get `ReplPlugin`, `ReplDefaultCommandsPlugin`, `ReplPlugins` group, `ReplAppExt::add_repl_command::<T>()`, events (`ReplSubmitEvent`, etc.). Looks ergonomic: add plugin(s), register commands, add observer systems.
- __Derive path__: Feature-gated via `bevy_repl_derive::ReplCommand`. README snippet aligns with this, but confirm feature flag spelling in `Cargo.toml` and docs.
- __Headless usage__: README shows `MinimalPlugins` + `ScheduleRunnerPlugin`. Good; examples should mirror that consistently.
- __Toggling__: README states backquote toggles; note reliability issue listed under Known Issues.

## Code Quality Snapshot

- __Structure__: Core in `src/repl.rs` (plugin, state, events, terminal context). Parsing/registration in `src/command/` with `ParserPlugin`, `CommandParser`, `ReplAppExt`. Prompt split into `input.rs`, `keymap.rs`, `render.rs`.
- __Docs__: `lib.rs` inlines `README.md` as crate docs. Public items re-exported via `prelude`.
- __Scheduling__: `ReplSet::{Toggle,Capture,Buffer,Render,Post}` chained between `InputSet::EmitCrossterm` and `InputSet::Post` — coherent.
- **Observations / Risks**:
  - Raw mode lifecycle: Current code restores raw mode on `Disable` in `manage_context()` and on exit in `cleanup_on_exit()`. This contradicts the note at top (always-on raw mode). Decide one behavior and align code + README. Always-on raw mode likely fixes toggle reliability.
  - Feature flag naming mismatch as above.
  - Example/API consistency: ensure all examples use `clap_command()` and compile under MSRV/bevy version.
  - Tests: No unit/integration tests found for parsing or buffer editing. Add at least parser and buffer tests.
  - Built-ins: `help`/`clear` listed as non-functional; consider hiding behind feature off by default or mark experimental.

### Design Decision (2025-08-09)

- __No runtime toggle in v1__: For the first iteration, the REPL will not be toggleable while the app is running. If `ReplPlugin` is added but the REPL is disabled at startup, the app must behave as if the REPL were not present.
  - Implications:
    - No keybind for toggling; remove toggle systems and events from v1 path.
    - When disabled, do not acquire terminal/enable raw mode, do not register REPL systems, and avoid side effects (events/resources) that alter scheduling.
    - Documentation and examples should reflect a static enabled/disabled configuration.

## Today’s Plan (prioritized)

1. __Make REPL inert when disabled__
   - Update `ReplPlugin` build to short-circuit: if disabled at startup, do not insert REPL resources, events, or systems; avoid raw mode/terminal acquisition.
   - Remove runtime toggle systems/events from v1 path; keep minimal code behind a feature flag or comment for future work.
2. **Update README and examples for v1**
   - State explicitly: no runtime toggle in v1; REPL is enabled/disabled at startup only.
   - Standardize feature flag spelling and `clap_command()` naming in snippets.
   - Ensure `examples/minimal.rs` shows static enabled REPL; add a `disabled` example showing no side effects.
3. **Built-ins sanity**
   - Make `help` and `clear` functional or exclude from default plugin and mark as experimental.
4. **Add basic tests**
   - Verify that when disabled, no REPL systems run and no terminal/raw mode is entered.
   - Parser: round-trip a sample command string to event struct.
   - Buffer: cursor movement, insert/delete/backspace.
5. (Stretch) **Post-v1 toggle plan (tracked only)**
   - Document future toggle approach and raw mode strategy; do not implement in v1.

## Quick Links

- `src/repl.rs`: plugin/state/events/raw mode
- `src/command/mod.rs`: `ReplCommand`, `ReplAppExt`, parsers
- `src/prompt/`: input, keymap, render
- `src/plugin.rs`: `ReplPlugins` group

---

